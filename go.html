<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業級本地計數器 - SQLite Style</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .locked { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="app" class="p-4 md:p-8">
    <header class="max-w-6xl mx-auto mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-calculator mr-2"></i>專業計數器</h1>
            <div class="flex flex-wrap gap-2">
                <button @click="addNewCounter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-plus mr-1"></i> 新增計數器
                </button>
                <button @click="exportAllData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                    <i class="fas fa-file-export mr-1"></i> 匯出全部 (JSON)
                </button>
            </div>
        </div>

        <div class="mt-6 flex flex-col md:flex-row gap-4">
            <input v-model="searchQuery" type="text" placeholder="搜尋名稱或標籤..." class="flex-1 p-2 border rounded-lg shadow-sm">
            <select v-model="sortBy" class="p-2 border rounded-lg bg-white">
                <option value="updated_at">按更新時間排序</option>
                <option value="name">按名稱排序</option>
                <option value="color">按顏色排序</option>
            </select>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <div class="card-grid">
            <div v-for="item in filteredCounters" :key="item.id" 
                 :style="{ borderTop: '6px solid ' + item.color }"
                 class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col transition-all hover:shadow-lg">
                
                <div class="p-4 border-b flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-gray-700">{{ item.name }}</h3>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="tag in item.tags" :key="tag" class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600">#{{ tag }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="toggleLock(item)" :class="item.is_locked ? 'text-red-500' : 'text-gray-400'">
                            <i :class="item.is_locked ? 'fas fa-lock' : 'fas fa-lock-open'"></i>
                        </button>
                        <button @click="openEdit(item)" class="text-blue-500"><i class="fas fa-edit"></i></button>
                        <button @click="deleteCounter(item.id)" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="p-6 flex-1 flex flex-col items-center justify-center bg-gray-50" :class="{ 'locked': item.is_locked }">
                    <div class="text-5xl font-black mb-6" :style="{ color: item.color }">{{ item.current_value }}</div>
                    <div class="flex gap-4 w-full">
                        <button @click="updateValue(item, -item.step_size)" class="flex-1 bg-white border-2 py-3 rounded-xl active:scale-95 transition hover:bg-gray-100 text-xl font-bold">-{{ item.step_size }}</button>
                        <button @click="updateValue(item, item.step_size)" class="flex-2 w-full bg-white border-2 py-3 rounded-xl active:scale-95 transition hover:bg-gray-100 text-xl font-bold" :style="{ borderColor: item.color, color: item.color }">+{{ item.step_size }}</button>
                    </div>
                </div>

                <div class="px-4 py-2 bg-white text-xs text-gray-400 flex justify-between items-center">
                    <span>最後更新: {{ formatDate(item.updated_at) }}</span>
                    <button @click="exportCSV(item)" class="hover:text-blue-600">導出 CSV</button>
                </div>
            </div>
        </div>
    </main>

    <div v-if="editingItem" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h2 class="text-xl font-bold mb-4">編輯計數器</h2>
            <div class="space-y-4">
                <label class="block">名稱：<input v-model="editingItem.name" type="text" class="w-full mt-1 border p-2 rounded"></label>
                <label class="block">步長 (-10 至 10)：<input v-model.number="editingItem.step_size" type="number" min="-10" max="10" class="w-full mt-1 border p-2 rounded"></label>
                <label class="block">主題顏色：<input v-model="editingItem.color" type="color" class="w-full h-10 mt-1 border p-1 rounded"></label>
                <label class="block">標籤 (逗號分隔)：<input v-model="tempTags" type="text" class="w-full mt-1 border p-2 rounded"></label>
                <label class="block flex items-center gap-2">音效回饋：
                    <select v-model="editingItem.sound" class="border p-1 rounded">
                        <option value="none">無</option>
                        <option value="tick">滴答聲</option>
                        <option value="voice">語音讀數</option>
                    </select>
                </label>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button @click="editingItem = null" class="px-4 py-2 text-gray-500">取消</button>
                <button @click="saveEdit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">儲存設定</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            const counters = ref([]);
            const searchQuery = ref('');
            const sortBy = ref('updated_at');
            const editingItem = ref(null);
            const tempTags = ref('');

            // 初始化與儲存邏輯 (模擬 SQLite 持久化)
            onMounted(() => {
                const saved = localStorage.getItem('local_counters');
                if (saved) counters.value = JSON.parse(saved);
            });

            watch(counters, (newVal) => {
                localStorage.setItem('local_counters', JSON.stringify(newVal));
            }, { deep: true });

            // 核心功能
            const addNewCounter = () => {
                const newObj = {
                    id: Date.now().toString(),
                    name: '新計數器',
                    current_value: 0,
                    step_size: 1,
                    color: '#3B82F6',
                    tags: ['通用'],
                    is_locked: false,
                    sound: 'tick',
                    logs: [],
                    updated_at: new Date().toISOString()
                };
                counters.value.unshift(newObj);
            };

            const updateValue = (item, delta) => {
                if (item.is_locked) return;
                item.current_value += delta;
                item.updated_at = new Date().toISOString();
                
                // 記錄日誌
                item.logs.push({ t: new Date().toISOString(), v: item.current_value });
                
                // 音效處理
                handleSound(item);
            };

            const handleSound = (item) => {
                if (item.sound === 'tick') {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800;
                    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.1);
                } else if (item.sound === 'voice') {
                    const msg = new SpeechSynthesisUtterance(item.current_value.toString());
                    msg.lang = 'zh-TW';
                    window.speechSynthesis.speak(msg);
                }
            };

            const openEdit = (item) => {
                editingItem.value = { ...item };
                tempTags.value = item.tags.join(', ');
            };

            const saveEdit = () => {
                editingItem.value.tags = tempTags.value.split(',').map(t => t.trim()).filter(t => t);
                const index = counters.value.findIndex(c => c.id === editingItem.value.id);
                counters.value[index] = editingItem.value;
                editingItem.value = null;
            };

            const deleteCounter = (id) => {
                if(confirm('確定要刪除嗎？所有日誌將消失。')) {
                    counters.value = counters.value.filter(c => c.id !== id);
                }
            };

            const toggleLock = (item) => { item.is_locked = !item.is_locked; };

            // 排序與搜尋
            const filteredCounters = computed(() => {
                let res = counters.value.filter(c => 
                    c.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                    c.tags.some(t => t.includes(searchQuery.value))
                );
                return res.sort((a, b) => {
                    if (sortBy.value === 'name') return a.name.localeCompare(b.name);
                    if (sortBy.value === 'color') return a.color.localeCompare(b.color);
                    return new Date(b.updated_at) - new Date(a.updated_at);
                });
            });

            // 匯出功能
            const exportCSV = (item) => {
                let csv = 'Time,Value\n' + item.logs.map(l => `${l.t},${l.v}`).join('\n');
                downloadBlob(csv, `${item.name}_logs.csv`, 'text/csv');
            };

            const exportAllData = () => {
                downloadBlob(JSON.stringify(counters.value), 'all_counters_backup.json', 'application/json');
            };

            const downloadBlob = (content, filename, contentType) => {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
            };

            const formatDate = (iso) => new Date(iso).toLocaleString();

            return {
                counters, searchQuery, sortBy, editingItem, tempTags,
                addNewCounter, updateValue, deleteCounter, toggleLock,
                openEdit, saveEdit, filteredCounters, exportCSV, exportAllData, formatDate
            };
        }
    }).mount('#app');
</script>

</body>
</html>
