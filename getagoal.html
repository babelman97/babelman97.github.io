<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業級本地計數器 - Cloud Sync 版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google API Libs -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .locked { opacity: 0.6; pointer-events: none; }
        /* 防止 Vue 未載入前閃爍，但如果出錯會導致空白，已在下文優化 */
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="app" v-cloak class="p-4 md:p-8">
    <header class="max-w-6xl mx-auto mb-8">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-calculator mr-2"></i>專業計數器</h1>
                <p class="text-sm text-gray-500 mt-1">支援 Google Drive 跨裝置同步</p>
                <!-- 偵測是否為本地開啟 -->
                <p v-if="isLocalFile" class="text-xs text-red-500 mt-1 font-bold">警告：Google 同步功能不支援直接開啟檔案，請使用 Local Server (http://)。</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <!-- Google Sync Controls -->
                <button v-if="!isLoggedIn" @click="handleAuth" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition flex items-center shadow-sm">
                    <img src="https://www.google.com/favicon.ico" class="w-4 h-4 mr-2"> 連結 Google 雲端
                </button>
                <div v-else class="flex gap-2">
                    <button @click="syncToCloud" :disabled="isSyncing" class="bg-blue-50 text-blue-600 border border-blue-200 px-4 py-2 rounded-lg hover:bg-blue-100 transition disabled:opacity-50">
                        <i class="fas" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'"></i> 上傳雲端
                    </button>
                    <button @click="syncFromCloud" :disabled="isSyncing" class="bg-orange-50 text-orange-600 border border-orange-200 px-4 py-2 rounded-lg hover:bg-orange-100 transition disabled:opacity-50">
                        <i class="fas" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud-download-alt'"></i> 下載雲端
                    </button>
                    <button @click="handleSignout" class="text-gray-400 hover:text-red-500 p-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                
                <button @click="addNewCounter" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow-md">
                    <i class="fas fa-plus mr-1"></i> 新增
                </button>
            </div>
        </div>

        <div class="mt-6 flex flex-col md:flex-row gap-4">
            <input v-model="searchQuery" type="text" placeholder="搜尋名稱或標籤..." class="flex-1 p-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
            <select v-model="sortBy" class="p-2 border rounded-lg bg-white shadow-sm">
                <option value="updated_at">按更新時間排序</option>
                <option value="name">按名稱排序</option>
                <option value="color">按顏色排序</option>
            </select>
        </div>
    </header>

    <main class="max-w-6xl mx-auto">
        <div v-if="filteredCounters.length === 0" class="text-center py-20 text-gray-400">
            <i class="fas fa-folder-open text-5xl mb-4"></i>
            <p>尚無計數器，請點擊上方「新增」或從雲端下載資料。</p>
        </div>
        
        <div class="card-grid">
            <div v-for="item in filteredCounters" :key="item.id" 
                 :style="{ borderTop: '6px solid ' + item.color }"
                 class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col transition-all hover:shadow-lg">
                
                <div class="p-4 border-b flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-gray-700">{{ item.name }}</h3>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-for="tag in item.tags" :key="tag" class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600">#{{ tag }}</span>
                        </div>
                    </div>
                    <div class="flex gap-2 text-sm">
                        <button @click="toggleLock(item)" :class="item.is_locked ? 'text-red-500' : 'text-gray-400'">
                            <i :class="item.is_locked ? 'fas fa-lock' : 'fas fa-lock-open'"></i>
                        </button>
                        <button @click="openEdit(item)" class="text-blue-500"><i class="fas fa-edit"></i></button>
                        <button @click="deleteCounter(item.id)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="p-6 flex-1 flex flex-col items-center justify-center bg-gray-50" :class="{ 'locked': item.is_locked }">
                    <div class="text-5xl font-black mb-6" :style="{ color: item.color }">{{ item.current_value }}</div>
                    <div class="flex gap-4 w-full">
                        <button @click="updateValue(item, -item.step_size)" class="flex-1 bg-white border-2 py-3 rounded-xl active:scale-95 transition hover:bg-gray-100 text-xl font-bold">-{{ item.step_size }}</button>
                        <button @click="updateValue(item, item.step_size)" class="flex-2 w-full bg-white border-2 py-3 rounded-xl active:scale-95 transition hover:bg-gray-100 text-xl font-bold" :style="{ borderColor: item.color, color: item.color }">+{{ item.step_size }}</button>
                    </div>
                </div>

                <div class="px-4 py-2 bg-white text-xs text-gray-400 flex justify-between items-center">
                    <span>最後更新: {{ formatDate(item.updated_at) }}</span>
                    <button @click="exportCSV(item)" class="hover:text-blue-600">導出 CSV</button>
                </div>
            </div>
        </div>
    </main>

    <!-- 編輯模態視窗 -->
    <div v-if="editingItem" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h2 class="text-xl font-bold mb-4">編輯計數器</h2>
            <div class="space-y-4">
                <label class="block text-sm font-medium">名稱：<input v-model="editingItem.name" type="text" class="w-full mt-1 border p-2 rounded shadow-sm"></label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="block text-sm font-medium">步長：<input v-model.number="editingItem.step_size" type="number" class="w-full mt-1 border p-2 rounded shadow-sm"></label>
                    <label class="block text-sm font-medium">主題顏色：<input v-model="editingItem.color" type="color" class="w-full h-10 mt-1 border p-1 rounded"></label>
                </div>
                <label class="block text-sm font-medium">標籤 (逗號分隔)：<input v-model="tempTags" type="text" placeholder="例如: 運動, 工作" class="w-full mt-1 border p-2 rounded shadow-sm"></label>
                <label class="block text-sm font-medium">音效回饋：
                    <select v-model="editingItem.sound" class="w-full mt-1 border p-2 rounded shadow-sm">
                        <option value="none">無</option>
                        <option value="tick">滴答聲</option>
                        <option value="voice">語音讀數</option>
                    </select>
                </label>
            </div>
            <div class="flex justify-end gap-3 mt-8">
                <button @click="editingItem = null" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">取消</button>
                <button @click="saveEdit" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- 狀態通知 -->
    <div v-if="toast.show" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl text-white transition-all transform z-[100]" :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'">
        {{ toast.msg }}
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    // --- Google API 設定 ---
    const CLIENT_ID = '794911308416-v7pbkb5etod2pr7is62e8ugq32dnj9ia.apps.googleusercontent.com'; 
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const SYNC_FILE_NAME = 'professional_counter_backup.json';

    createApp({
        setup() {
            const counters = ref([]);
            const searchQuery = ref('');
            const sortBy = ref('updated_at');
            const editingItem = ref(null);
            const tempTags = ref('');
            const toast = ref({ show: false, msg: '', type: 'success' });
            const isLocalFile = ref(window.location.protocol === 'file:');

            const isLoggedIn = ref(false);
            const isSyncing = ref(false);
            let tokenClient;
            let gapiToken = null;

            onMounted(() => {
                const saved = localStorage.getItem('local_counters');
                if (saved) counters.value = JSON.parse(saved);
                
                // 非本地開啟時才嘗試初始化 Google API
                if (!isLocalFile.value) {
                    setTimeout(initGoogleAPI, 1000); 
                }
            });

            watch(counters, (newVal) => {
                localStorage.setItem('local_counters', JSON.stringify(newVal));
            }, { deep: true });

            const initGoogleAPI = () => {
                try {
                    if (typeof gapi === 'undefined' || typeof google === 'undefined') {
                        console.warn("Google API SDK 未載入");
                        return;
                    }

                    gapi.load('client', async () => {
                        await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                    });

                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: (resp) => {
                            if (resp.error) {
                                showToast("授權失敗: " + resp.error, "error");
                                return;
                            }
                            gapiToken = resp;
                            isLoggedIn.value = true;
                            showToast("已成功連結 Google 帳號");
                        },
                    });
                } catch (err) {
                    console.error("API Init Error:", err);
                }
            };

            const handleAuth = () => {
                if (isLocalFile.value) {
                    alert("由於 Google 安全限制，同步功能無法在直接開啟 HTML 檔案時使用。\n請將此檔案上傳至伺服器或使用本地伺服器 (如 Live Server)。");
                    return;
                }
                tokenClient.requestAccessToken({ prompt: 'consent' });
            };

            const handleSignout = () => {
                if (gapiToken) {
                    google.accounts.oauth2.revoke(gapiToken.access_token);
                    isLoggedIn.value = false;
                    gapiToken = null;
                    showToast("已中斷連結");
                }
            };

            const syncToCloud = async () => {
                try {
                    isSyncing.value = true;
                    const fileId = await findSyncFile();
                    const metadata = { name: SYNC_FILE_NAME, mimeType: 'application/json' };
                    const blob = new Blob([JSON.stringify(counters.value)], { type: 'application/json' });

                    if (fileId) {
                        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                            method: 'PATCH',
                            headers: { 'Authorization': `Bearer ${gapiToken.access_token}` },
                            body: blob
                        });
                    } else {
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        form.append('file', blob);
                        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${gapiToken.access_token}` },
                            body: form
                        });
                    }
                    showToast("備份上傳成功！");
                } catch (e) {
                    showToast("上傳失敗，請重新連結帳號", "error");
                } finally {
                    isSyncing.value = false;
                }
            };

            const syncFromCloud = async () => {
                try {
                    isSyncing.value = true;
                    const fileId = await findSyncFile();
                    if (!fileId) {
                        showToast("雲端沒有發現備份檔", "error");
                        return;
                    }
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${gapiToken.access_token}` }
                    });
                    const data = await response.json();
                    if (confirm(`確認下載雲端資料並覆蓋現有的 ${counters.value.length} 個計數器嗎？`)) {
                        counters.value = data;
                        showToast("同步完成！");
                    }
                } catch (e) {
                    showToast("下載失敗", "error");
                } finally {
                    isSyncing.value = false;
                }
            };

            const findSyncFile = async () => {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${SYNC_FILE_NAME}' and trashed = false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                return response.result.files.length > 0 ? response.result.files[0].id : null;
            };

            const showToast = (msg, type = 'success') => {
                toast.value = { show: true, msg, type };
                setTimeout(() => toast.value.show = false, 3000);
            };

            // 原有邏輯保持
            const addNewCounter = () => {
                counters.value.unshift({
                    id: Date.now().toString(),
                    name: '計數器 ' + (counters.value.length + 1),
                    current_value: 0,
                    step_size: 1,
                    color: '#3B82F6',
                    tags: ['通用'],
                    is_locked: false,
                    sound: 'tick',
                    logs: [],
                    updated_at: new Date().toISOString()
                });
            };

            const updateValue = (item, delta) => {
                if (item.is_locked) return;
                item.current_value += delta;
                item.updated_at = new Date().toISOString();
                item.logs.push({ t: new Date().toISOString(), v: item.current_value });
                handleSoundFeedback(item);
            };

            const handleSoundFeedback = (item) => {
                if (item.sound === 'tick') {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = 850;
                    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
                    osc.start(); osc.stop(ctx.currentTime + 0.1);
                } else if (item.sound === 'voice') {
                    const msg = new SpeechSynthesisUtterance(item.current_value.toString());
                    msg.lang = 'zh-TW';
                    window.speechSynthesis.speak(msg);
                }
            };

            const openEdit = (item) => {
                editingItem.value = { ...item };
                tempTags.value = item.tags.join(', ');
            };

            const saveEdit = () => {
                editingItem.value.tags = tempTags.value.split(',').map(t => t.trim()).filter(t => t);
                const index = counters.value.findIndex(c => c.id === editingItem.value.id);
                counters.value[index] = editingItem.value;
                editingItem.value = null;
            };

            const deleteCounter = (id) => {
                if(confirm('確定刪除？')) counters.value = counters.value.filter(c => c.id !== id);
            };

            const toggleLock = (item) => item.is_locked = !item.is_locked;

            const filteredCounters = computed(() => {
                let res = counters.value.filter(c => 
                    c.name.toLowerCase().includes(searchQuery.value.toLowerCase()) ||
                    c.tags.some(t => t.includes(searchQuery.value))
                );
                return res.sort((a, b) => {
                    if (sortBy.value === 'name') return a.name.localeCompare(b.name);
                    if (sortBy.value === 'color') return a.color.localeCompare(b.color);
                    return new Date(b.updated_at) - new Date(a.updated_at);
                });
            });

            const exportCSV = (item) => {
                const csv = 'Time,Value\n' + item.logs.map(l => `${l.t},${l.v}`).join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
                a.download = `${item.name}.csv`; a.click();
            };

            const formatDate = (iso) => new Date(iso).toLocaleString();

            return {
                counters, searchQuery, sortBy, editingItem, tempTags, toast, isLocalFile,
                isLoggedIn, isSyncing, handleAuth, handleSignout, syncToCloud, syncFromCloud,
                addNewCounter, updateValue, deleteCounter, toggleLock,
                openEdit, saveEdit, filteredCounters, exportCSV, formatDate
            };
        }
    }).mount('#app');
</script>

</body>
</html>
